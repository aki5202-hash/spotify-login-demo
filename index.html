<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="UTF-8">
<title>Spotify Web Player Playlist Loader</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<style>
body { background:#0b1020; color:white; font-family:Arial; padding:20px; }
input, button { padding:10px; border-radius:8px; }
button { font-weight:bold; cursor:pointer; }
.card { background:#141927; padding:16px; border-radius:12px; margin-bottom:20px; }
iframe { width:100%; height:600px; border-radius:12px; margin-top:10px; }
</style>
</head>

<body>

<h1>Spotify Web Player（完整播放器）</h1>

<div class="card">
  <button id="loginBtn">登入 Spotify</button>
  <span id="loginStatus"></span>
</div>

<div class="card">
  <h2>輸入 Spotify 歌單網址</h2>
  <input id="playlistUrl" placeholder="貼上 Spotify Playlist URL" style="width:100%;">
  <br><br>
  <button id="loadBtn">載入 Web Player</button>
</div>

<div class="card">
  <h2>Spotify Web Player</h2>
  <iframe id="webplayer" src=""></iframe>
</div>

<script>
// ========== PKCE ==========
async function sha256(plain) {
  const encoder = new TextEncoder();
  const data = encoder.encode(plain);
  return crypto.subtle.digest("SHA-256", data);
}

function base64urlencode(a) {
  return btoa(String.fromCharCode.apply(null, new Uint8Array(a)))
    .replace(/\+/g, "-").replace(/\//g, "_").replace(/=+$/, "");
}

async function generateChallenge(v) {
  const digest = await sha256(v);
  return base64urlencode(digest);
}

const clientId = "aec8a9bf8f32434490bb473786779b9b";
const redirectUri = window.location.origin;
let accessToken = null;

// ========== Login ==========
document.getElementById("loginBtn").onclick = async () => {
  const verifier = base64urlencode(crypto.getRandomValues(new Uint8Array(32)));
  localStorage.setItem("code_verifier", verifier);
  const challenge = await generateChallenge(verifier);

  const params = new URLSearchParams({
    response_type: "code",
    client_id: clientId,
    redirect_uri: redirectUri,
    code_challenge_method: "S256",
    code_challenge: challenge,
    scope: "playlist-read-private playlist-read-collaborative"
  });

  window.location = "https://accounts.spotify.com/authorize?" + params.toString();
};

// ========== Handel Redirect ==========
(async () => {
  const code = new URLSearchParams(window.location.search).get("code");
  if (!code) return;

  const verifier = localStorage.getItem("code_verifier");
  const body = new URLSearchParams({
    grant_type:"authorization_code",
    code,
    redirect_uri: redirectUri,
    client_id: clientId,
    code_verifier: verifier
  });

  const res = await fetch("https://accounts.spotify.com/api/token", {
    method:"POST",
    headers:{ "Content-Type":"application/x-www-form-urlencoded" },
    body
  });

  const data = await res.json();
  accessToken = data.access_token;

  document.getElementById("loginStatus").textContent = "已登入 Spotify ✔";

  // 清掉 query string
  window.history.replaceState({}, "", redirectUri);
})();

// ========== Extract Playlist ID ==========
function extractId(url) {
  try {
    url = url.split("?")[0];
    const u = new URL(url);
    const parts = u.pathname.split("/");
    return parts[parts.length - 1];
  } catch {
    return url;
  }
}

// ========== Load Full Web Player ==========

document.getElementById("loadBtn").onclick = () => {
  const url = document.getElementById("playlistUrl").value.trim();
  if (!url) return alert("請輸入歌單網址");

  const id = extractId(url);

  // 這是 Spotify 的整個 Web Player embed，不是 preview
  const embed = `https://open.spotify.com/embed/playlist/${id}`;

  document.getElementById("webplayer").src = embed;
};

</script>
</body>
</html>
