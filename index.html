<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8">
  <title>Spotify Auto Preview Player (Rebuilt)</title>
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <style>
    body { background:#0b1020; color:#fff; font-family:Arial; padding:20px; }
    input,button { padding:10px; border-radius:6px; }
    button { cursor:pointer; font-weight:bold; }
    .card { background:#141927; padding:16px; border-radius:12px; margin-bottom:20px; }
    .track { display:flex; gap:10px; align-items:center; padding:10px 0; border-bottom:1px solid #333; }
    img { width:60px; height:60px; border-radius:6px; }
    #player { width:100%; height:352px; border-radius:12px; margin-top:10px; }
  </style>
</head>

<body>

<h1>Spotify è‡ªå‹• 30 ç§’é è¦½æ’­æ”¾å™¨ï¼ˆé‡æ§‹ç‰ˆï¼‰</h1>

<div class="card">
  <button id="loginBtn">ç™»å…¥ Spotify</button>
  <span id="loginStatus"></span>
</div>

<div class="card">
  <h2>è¼‰å…¥ Spotify æ­Œå–®</h2>
  <input id="playlistUrl" placeholder="è²¼ä¸Š Spotify æ­Œå–®ç¶²å€" style="width:100%;">
  <br><br>
  <button id="loadBtn">è¼‰å…¥æ­Œå–®</button>
</div>

<div class="card">
  <h2>æ­Œå–®æ›²ç›®</h2>
  <button id="playAll" style="background:#1DB954;color:white;margin-bottom:12px;">
    â–¶ æ’­æ”¾å…¨éƒ¨ï¼ˆå¾ç¬¬ä¸€é¦–ï¼‰
  </button>
  <div id="list"></div>

  <h3 style="margin-top:20px;">è©¦è½æ’­æ”¾å™¨ï¼ˆSpotify Previewï¼‰</h3>
  <iframe id="player" src="" frameborder="0" allow="encrypted-media"></iframe>
</div>

<script>
/* -------------------------------------------------------
   CONFIG
------------------------------------------------------- */
const clientId = "aec8a9bf8f32434490bb473786779b9b";

// ğŸ”¥ æœ€é‡è¦ä¿®æ­£ï¼šredirectUri å¿…é ˆæŒ‡å‘ index.html
const redirectUri = window.location.origin + "/index.html";

let accessToken = null;
let tracks = [];
let index = 0;
let timer = null;

/* -------------------------------------------------------
   PKCE FUNCTIONS
------------------------------------------------------- */
async function sha256(str){
  const buf = new TextEncoder().encode(str);
  return crypto.subtle.digest("SHA-256", buf);
}
function base64url(arr){
  return btoa(String.fromCharCode(...new Uint8Array(arr)))
    .replace(/\+/g,"-").replace(/\//g,"_").replace(/=+$/,"");
}
async function genChallenge(v){
  const hash = await sha256(v);
  return base64url(hash);
}

/* -------------------------------------------------------
   LOGIN
------------------------------------------------------- */
document.getElementById("loginBtn").onclick = async () => {
  const verifier = base64url(crypto.getRandomValues(new Uint8Array(32)));
  localStorage.setItem("verifier", verifier);

  const challenge = await genChallenge(verifier);

  const params = new URLSearchParams({
    client_id: clientId,
    response_type: "code",
    redirect_uri: redirectUri,
    code_challenge_method: "S256",
    code_challenge: challenge,
    scope:"playlist-read-private playlist-read-collaborative"
  });

  window.location = "https://accounts.spotify.com/authorize?" + params;
};

/* -------------------------------------------------------
   REDIRECT HANDLER
------------------------------------------------------- */
async function handleRedirect(){
  const p = new URLSearchParams(window.location.search);
  const code = p.get("code");
  if (!code) return;

  const verifier = localStorage.getItem("verifier");

  const body = new URLSearchParams({
    grant_type:"authorization_code",
    code:code,
    redirect_uri:redirectUri,
    client_id:clientId,
    code_verifier:verifier
  });

  const r = await fetch("https://accounts.spotify.com/api/token",{
    method:"POST",
    headers:{ "Content-Type":"application/x-www-form-urlencoded" },
    body
  });

  const data = await r.json();

  if(!data.access_token){
    alert("ç™»å…¥å¤±æ•ˆï¼Œè«‹é‡æ–°ç™»å…¥");
    window.location = redirectUri;
    return;
  }

  accessToken = data.access_token;
  document.getElementById("loginStatus").textContent="å·²ç™»å…¥ Spotify âœ”";

  // ğŸ”¥ æ°¸é æ¸…æ‰ URLï¼Œä¸æœƒå†å¡ load playlist
  window.history.replaceState({}, "", redirectUri);
}
handleRedirect();

/* -------------------------------------------------------
   LOAD PLAYLIST
------------------------------------------------------- */
function extractId(url){
  return url.split("?")[0].split("/").pop().trim();
}

document.getElementById("loadBtn").onclick = async () => {

  if (!accessToken){
    alert("è«‹å…ˆç™»å…¥ Spotify");
    return;
  }

  const pid = extractId(document.getElementById("playlistUrl").value);

  const r = await fetch(
    `https://api.spotify.com/v1/playlists/${pid}/tracks?limit=200`,
    { headers:{ Authorization:"Bearer "+accessToken }}
  );

  const data = await r.json();

  if(!data.items){
    alert("æ­Œå–®è¼‰å…¥å¤±æ•—ï¼Œè«‹ç¢ºèªç¶²å€");
    return;
  }

  const list = document.getElementById("list");
  list.innerHTML = "";

  tracks = data.items.map(i => i?.track?.id).filter(Boolean);
  index = 0;

  data.items.forEach((item, i)=>{
    const t = item.track;
    if(!t) return;

    const div = document.createElement("div");
    div.className="track";

    div.innerHTML = `
      <img src="${t.album.images[2]?.url || t.album.images[0]?.url}">
      <div style="flex:1;">
        <div>${t.name}</div>
        <div style="font-size:12px;color:#aaa;">${t.artists.map(a=>a.name).join(", ")}</div>
      </div>
      <button onclick="playTrack(${i})">æ’­æ”¾</button>
    `;
    list.appendChild(div);
  });
};

/* -------------------------------------------------------
   PLAYBACK + AUTO NEXT
------------------------------------------------------- */
function playTrack(i){
  index = i;

  const id = tracks[index];
  const player = document.getElementById("player");
  player.src = `https://open.spotify.com/embed/track/${id}`;

  if(timer) clearTimeout(timer);
  timer = setTimeout(nextTrack, 30000);
}

function nextTrack(){
  index++;
  if(index >= tracks.length){
    alert("å…¨éƒ¨æ’­æ”¾å®Œç•¢ï¼");
    return;
  }
  playTrack(index);
}

document.getElementById("playAll").onclick = () => {
  if(!tracks.length) return alert("è«‹å…ˆè¼‰å…¥æ­Œå–®");
  playTrack(0);
};

</script>
</body>
</html>
